#library packages--------------------
library(ggplot2)
library(survival)
library(survminer)
library(reportReg)
library(gtsummary)
library(nhanesR)
library(dplyr)
library(mediation)
library(Publish)
library(export)
library(patchwork)
library(eoffice)
library(foreign)
library(compareGroups)
library(glue)
library(rms)
library(scales)
library(ggrcs)
library(ggpubr)
library(cowplot)
library(tidyverse)
#read data--------------------
base <- read.csv("E:/Database/UKB/Baseline/Baseline_information_20231125.csv", stringsAsFactors=FALSE)
acc <- read.csv("E:/Database/UKB/Physical Activity/PA_accel.csv", stringsAsFactors=FALSE)
prog <- read.csv("E:/Database/UKB/Prognosis/Mortality_and_reason.csv", stringsAsFactors=FALSE)
head(table(prog$Underlying..primary..cause.of.death..ICD10...Instance.0)[order(table(prog$Underlying..primary..cause.of.death..ICD10...Instance.0), decreasing = TRUE)], 20)|>print()
occur<- read.csv("E:/Database/UKB/Prognosis/Outcome_first-occur_Circulation-and-diabetes_2023-11-27_participant.csv",stringsAsFactors=FALSE)
acc_time <- read.csv("E:/Database/UKB/Physical Activity/Accelerometer_wear_time_duration_20231212.csv", stringsAsFactors=FALSE)
acc_time <- subset(acc_time, select = c(Participant.ID, Data.quality..good.wear.time,End.time.of.wear))
acc_cal <- read.csv("E:/Database/UKB/Physical Activity/Accelerometer_calibration_20231212.csv", stringsAsFactors=FALSE)
acc_cal <- subset(acc_cal, select = c(Participant.ID,Data.quality..good.calibration))
summary(y1$MVPA_week_sum)
alcohol <- read.csv("E:/Database/UKB/Lifestyle/Lifestyle_Alcohol_Sun_Sex_20231214.csv", stringsAsFactors=FALSE)
NO2 <- read.csv("E:/Database/UKB/Module/Air pollution/NO2/NO2_for_PA.csv",stringsAsFactors=FALSE)
PM25<- read.csv("E:/Database/UKB/Module/Air pollution/PM25/PM25_for_PA.csv",stringsAsFactors=FALSE)
lipid <- read.csv("E:/Database/UKB/Prognosis/Endocrine_nutritional_metabolic_diseases_2024_04_07.csv", stringsAsFactors=FALSE)
lipid <- subset(lipid, select = c(Participant.ID, Date.E78.first.reported..disorders.of.lipoprotein.metabolism.and.other.lipidaemias.,Source.of.report.of.E78..disorders.of.lipoprotein.metabolism.and.other.lipidaemias.))
fuel <- read.csv("E:/Database/UKB/Baseline/Household_20240329.csv", stringsAsFactors=FALSE)
smoke <- read.csv("E:/Database/UKB/Lifestyle/Smoking_20240329.csv", stringsAsFactors=FALSE)
summary(smoke$Exposure.to.tobacco.smoke.at.home...Instance.1)
smoke <- subset(smoke,select = c(Participant.ID,Exposure.to.tobacco.smoke.outside.home...Instance.0,
                                 Exposure.to.tobacco.smoke.outside.home...Instance.1,
                                 Exposure.to.tobacco.smoke.at.home...Instance.0,
                                 Exposure.to.tobacco.smoke.at.home...Instance.1))
cancer <- read.csv("E:/Database/UKB/Prognosis/Cancer_register_20240508.csv", stringsAsFactors=FALSE)
sum(cancer$Date.of.cancer.diagnosis...Instance.0  !="")
summary(cancer$Date.of.cancer.diagnosis...Instance.0)
date_vars <- grep("^Date.of.cancer.diagnosis...Instance.", names(cancer), value = TRUE)
cancer[date_vars] <- lapply(cancer[date_vars], as.Date, format = "%Y-%m-%d")
summary(cancer$Date.of.cancer.diagnosis...Instance.17)
cancer$cancer_date <- do.call(pmin, c(cancer[date_vars], na.rm = TRUE))
View(cancer[is.na(cancer$Date.of.cancer.diagnosis...Instance.0) != T, 
            c("Date.of.cancer.diagnosis...Instance.0","Date.of.cancer.diagnosis...Instance.1", 
              "Date.of.cancer.diagnosis...Instance.2","Date.of.cancer.diagnosis...Instance.3", 
              "Date.of.cancer.diagnosis...Instance.4","Date.of.cancer.diagnosis...Instance.5","cancer_date")])
cancer <- subset(cancer,select = c(Participant.ID,cancer_date))


x <- merge(base, prog, by = "Participant.ID", all.x = TRUE)

x <- merge(x, occur, by = "Participant.ID", all.x = TRUE)

x <- merge(x, acc, by = "Participant.ID", all.x = TRUE)

x <- merge(x, acc_time, by = "Participant.ID", all.x = TRUE)
x <- merge(x, acc_cal, by = "Participant.ID", all.x = TRUE)
x <- merge(x, alcohol, by = "Participant.ID", all.x = TRUE)
x <- merge(x, PM25, by = "Participant.ID", all.x = TRUE)
x <- merge(x, lipid, by = "Participant.ID", all.x = TRUE)
x <- merge(x, fuel, by = "Participant.ID", all.x = TRUE)
x <- merge(x, smoke, by = "Participant.ID", all.x = TRUE)
x <- merge(x, NO2, by = "Participant.ID", all.x = TRUE)
x <- merge(x, PM25_2017, by = "Participant.ID", all.x = TRUE)
x <- merge(x, cancer, by = "Participant.ID", all.x = TRUE)
y<-x

#Endpoints--------------------
y$Mort[y$Date.of.death...Instance.0==""] <- 0
y$Mort[y$Date.of.death...Instance.0!=""] <- 1
table(y$Mort,exclude = NULL)

y$date_in <- as.Date(y$End.time.of.wear)
y$date_death0 <- as.Date(y$Date.of.death...Instance.0)
y$date_end <- as.Date("2022-11-30")
summary(y$date_death0)
summary(y$date_in)

y$date_end[is.na(y$date_death0)!=T] <- y$date_death0[is.na(y$date_death0)!=T]

y$follow_time <- difftime(y$date_end, y$date_in, units = c("auto"))
y$follow_time <- as.numeric(y$follow_time, units = "days") # 日期转换成数值
y$follow_time <- y$follow_time/365
summary(y$follow_time)

y$CVD_death <- ifelse(grepl("I0|I1|I2|I3|I4|I5|I6|I7|I8|I9", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
table(y$CVD_death,exclude = NULL)
y$IHD_death <- ifelse(grepl("I20|I21|I22|I23|I24|I25", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$AMI_death <- ifelse(grepl("I21", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$CIHD_death <- ifelse(grepl("I25", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)

y$Cere_death <- ifelse(grepl("I6", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$Stroke_death <- ifelse(grepl("I60|I61|I63|I64", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)

y$Cancer_death <- ifelse(grepl("C0|C1|C2|C3|C4|C5|C6|C7|C8|C9", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$Resp_cancer_death <- ifelse(grepl("C32|C33|C34", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$Lung_cancer_death <- ifelse(grepl("C33|C34", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)
y$Resp_death <- ifelse(grepl("J0|J1|J2|J3|J4|J5|J6|J7|J8|J9", y$Underlying..primary..cause.of.death..ICD10...Instance.0),1,0)

#Sample1：ACC--------------------------
y <- subset(y,y$Data.quality..good.wear.time!="") # 103661 start
table(y$Data.quality..good.wear.time,exclude = NULL)
y <- subset(y,y$Data.quality..good.wear.time=="Yes") # -6992
table(y$Data.quality..good.calibration,exclude = NULL)
y <- subset(y,y$Data.quality..good.calibration=="Yes") # -4
y <- subset(y,y$Moderate.Vigorous...Overall.average...Instance.0!="") # -1

sum(y$Moderate.Vigorous...Day.average...Instance.0=="")
sum(y$Moderate.Vigorous...Overall.average...Instance.0=="")

#View(y[, c("Participant.ID","Moderate.Vigorous...Day.average...Instance.0","Moderate.Vigorous...Overall.average...Instance.0")])
#y <- subset(y,y$Moderate.Vigorous...Day.average...Instance.0!="") # -1160

#covariates-----------------------------
table(y$UK.Biobank.assessment.centre...Instance.0,exclude = NULL)
# Recode(y$UK.Biobank.assessment.centre...Instance.0)
y$centre <- Recode(y$UK.Biobank.assessment.centre...Instance.0,
	"Manchester::English", 
	"Croydon::English", 
	"Reading::English", 
	"Newcastle::English", 
	"Oxford::English", 
	"Nottingham::English", 
	"Hounslow::English", 
	"Barts::English", 
	"Bury::English", 
	"Birmingham::English", 
	"Middlesborough::English", 
	"Sheffield::English", 
	"Stoke::English", 
	"Edinburgh::Scotland", 
	"Leeds::English", 
	"Liverpool::English", 
	"Cardiff::Wales", 
	"Stockport (pilot)::English", 
	"Bristol::English", 
	"Wrexham::Wales", 
	"Glasgow::Scotland", 
	"Swansea::Wales",
	to.numeric = FALSE)
table(y$centre,exclude = NULL)

y$date_assess <- as.Date(y$Date.of.attending.assessment.centre...Instance.0)

y$diff_time_PA_assess <- difftime(y$date_in,y$date_assess,units = c("auto"))
y$diff_time_PA_assess <- as.numeric(y$diff_time_PA_assess, units = "days") # 日期转换成数值
y$age <- y$diff_time_PA_assess/365 + y$Age.at.recruitment
summary(y$age)
y$sex <- y$Sex
table(y$sex,exclude = NULL)

y$race <- y$Ethnic.background...Instance.0
table(y$race,exclude = NULL)
y$white <- ifelse(y$race=="British"|y$race=="Any other white background"|
                    y$race=="Irish"|y$race=="White",1,0)
y$white[y$race=="Prefer not to answer"|y$race==""] <- NA
table(y$white,exclude = NULL)

table(y$Qualifications...Instance.1,exclude = NULL)
y$edu <- y$Qualifications...Instance.0
table(y$edu,exclude = NULL)
sum(grepl("College", y$edu))
sum(grepl("Univer", x$Qualifications...Instance.0))
y$college0 <- ifelse(grepl("College", y$Qualifications...Instance.0),1,0)
y$college1 <- ifelse(grepl("College", y$Qualifications...Instance.1),1,0)
y$college0[y$Qualifications...Instance.0=="Prefer not to answer"|y$Qualifications...Instance.0==""] <- NA
y$college1[y$Qualifications...Instance.1=="Prefer not to answer"|y$Qualifications...Instance.1==""] <- NA
table(y$college0,exclude = NULL)
table(y$college1,exclude = NULL)
y$college <- ifelse(is.na(y$college1)==T,y$college0,y$college1)
table(y$college,exclude = NULL)
#View(y[, c("Participant.ID","college0","college1","college")])

y$employment0 <- ifelse(grepl("paid employment",y$Current.employment.status...Instance.0),1,0)
y$employment0[y$Current.employment.status...Instance.0=="Prefer not to answer"|y$Current.employment.status...Instance.0==""] <- NA
y$employment1 <- ifelse(grepl("paid employment",y$Current.employment.status...Instance.1),1,0)
y$employment1[y$Current.employment.status...Instance.1=="Prefer not to answer"|y$Current.employment.status...Instance.1==""] <- NA

y$employment <- ifelse(is.na(y$employment1)==T,y$employment0,y$employment1)
table(y$employment,exclude = NULL)

y$smoke0 <- y$Smoking.status...Instance.0
y$smoke1 <- y$Smoking.status...Instance.1

table(y$smoke1,exclude = NULL)
# Recode(y$smoke)
y$smoke0 <- Recode(y$smoke0,
	"Previous::", 
	"Never::", 
	"Current::", 
	"Prefer not to answer::NA", 
	"::NA",
	to.numeric = FALSE)
y$smoke1 <- Recode(y$smoke1,
                   "Previous::", 
                   "Never::", 
                   "Current::", 
                   "Prefer not to answer::NA", 
                   "::NA",
                   to.numeric = FALSE)
y$smoke <- ifelse(is.na(y$smoke1)==T,y$smoke0,y$smoke1)
y$smoke <- factor(y$smoke, levels = c("Never","Previous","Current"))
table(y$smoke,exclude = NULL)

table(y$Alcohol.drinker.status...Instance.0.x)
y$drinker0 <- y$Alcohol.drinker.status...Instance.0.x
y$drinker1 <- y$Alcohol.drinker.status...Instance.1.x
table(y$drinker1,exclude = NULL)
# Recode(y$drinker0)
y$drinker0 <- Recode(y$drinker0,
	"Current::", 
	"Never::", 
	"Previous::", 
	"Prefer not to answer::NA", 
	"::NA",
	to.numeric = FALSE)

# Recode(y$drinker1)
y$drinker1 <- Recode(y$drinker1,
	"::NA", 
	"Current::", 
	"Never::", 
	"Previous::", 
	"Prefer not to answer::NA",
	to.numeric = FALSE)

y$drinker <- ifelse(is.na(y$drinker1)==T,y$drinker0,y$drinker1)
table(y$drinker,exclude = NULL)
y$drinker <- factor(y$drinker, levels = c("Never","Previous",
                                          "Current"))
table(y$drinker,exclude = NULL)

y$BMI0 <- y$Body.mass.index..BMI....Instance.0
y$BMI1 <- y$Body.mass.index..BMI....Instance.1
y$BMI <- ifelse(is.na(y$BMI1)==T,y$BMI0,y$BMI1)
summary(y$BMI)

y$waist0 <- y$Waist.circumference...Instance.0
y$waist1 <- y$Waist.circumference...Instance.1
y$waist <- ifelse(is.na(y$waist1)==T,y$waist0,y$waist1)
summary(y$waist)

table(y$Average.total.household.income.before.tax...Instance.0,exclude = NULL)
# Recode(y$Average.total.household.income.before.tax...Instance.0)
y$income0 <- Recode(y$Average.total.household.income.before.tax...Instance.0,
	"31,000 to 51,999::2-18,000 to 51,999", 
	"52,000 to 100,000::3-52,000 to 100,000", 
	"18,000 to 30,999::2-18,000 to 51,999", 
	"Greater than 100,000::4-Greater than 100,000", 
	"Prefer not to answer::5-NA", 
	"Less than 18,000::1-Less than 18,000", 
	"Do not know::5-NA", 
	"::5-NA",
	to.numeric = FALSE)
y$income1 <- Recode(y$Average.total.household.income.before.tax...Instance.1,
                   "31,000 to 51,999::2-18,000 to 51,999", 
                   "52,000 to 100,000::3-52,000 to 100,000", 
                   "18,000 to 30,999::2-18,000 to 51,999", 
                   "Greater than 100,000::4-Greater than 100,000", 
                   "Prefer not to answer::5-NA", 
                   "Less than 18,000::1-Less than 18,000", 
                   "Do not know::5-NA", 
                   "::5-NA",
                   to.numeric = FALSE)
table(y$income0,exclude = NULL)
y$income <- ifelse(y$income1=="5-NA",y$income0,y$income1)
table(y$income,exclude = NULL)

#TDI----------------
y$TDI <- y$Townsend.deprivation.index.at.recruitment

##Hypertension--------------
sum(y$Date.I15.first.reported..secondary.hypertension.=="")
sum(y$Date.I10.first.reported..essential..primary..hypertension.=="")
sum(y$Date.I11.first.reported..hypertensive.heart.disease.  =="")
sum(y$Date.I12.first.reported..hypertensive.renal.disease.  =="")
sum(y$Date.I13.first.reported..hypertensive.heart.and.renal.disease. =="")

y$Hyp_date1 <- as.Date(y$Date.I10.first.reported..essential..primary..hypertension.)
y$Hyp_date2 <- as.Date(y$Date.I11.first.reported..hypertensive.heart.disease.)
y$Hyp_date3 <- as.Date(y$Date.I12.first.reported..hypertensive.renal.disease.)
y$Hyp_date4 <- as.Date(y$Date.I13.first.reported..hypertensive.heart.and.renal.disease.)
y$Hyp_date5 <- as.Date(y$Date.I15.first.reported..secondary.hypertension.)

y$Hyp_date <- apply(y[, c("Hyp_date1", "Hyp_date2", "Hyp_date3", "Hyp_date4", "Hyp_date5")], 1, function(x) min(x, na.rm = TRUE))

y$Hypertension <-0
y$Hypertension[y$Hyp_date <= y$date_in] <-1
table(y$Hypertension,exclude = NULL)

View(y[,c("Hyp_date1","Hyp_date2", 
              "Hyp_date3","Hyp_date4", 
              "Hyp_date5","Hyp_date","date_in","Hypertension")])


##Hyperlipidemia--------------
sum(y$Date.E78.first.reported..disorders.of.lipoprotein.metabolism.and.other.lipidaemias.!="",na.rm = T)
y$Lipidemia_date <- as.Date(y$Date.E78.first.reported..disorders.of.lipoprotein.metabolism.and.other.lipidaemias.)
sum(y$Lipidemia_date <= y$date_in,na.rm = T)
y$Dislipidemia <-0
y$Dislipidemia[y$Lipidemia_date <= y$date_in] <-1
table(y$Dislipidemia,exclude = NULL)

##Diabetes----------------
#y$DM_E14 <- as.Date(y$Date.E14.first.reported..unspecified.diabetes.mellitus.)
#y$DM_E13 <- as.Date(y$Date.E13.first.reported..other.specified.diabetes.mellitus.)
#y$DM_E12 <- as.Date(y$Date.E12.first.reported..malnutrition.related.diabetes.mellitus.)
y$DM_E11 <- as.Date(y$Date.E11.first.reported..non.insulin.dependent.diabetes.mellitus.) 
#y$DM_E10 <- as.Date(y$Date.E10.first.reported..insulin.dependent.diabetes.mellitus.)

#y$DM_time <- pmin(y$DM_E14,y$DM_E13,y$DM_E12,y$DM_E11,y$DM_E10,na.rm = T)

sum(y$DM_E11 <= y$date_in,na.rm = T)
y$DM_history <- 0
y$DM_history[y$DM_E11 <= y$date_in] <-1
table(y$DM_history,exclude = NULL)

##myocardial infarction--------------------------------
y$Date.I21.first.reported..acute.myocardial.infarction. <- as.Date(y$Date.I21.first.reported..acute.myocardial.infarction.)
y$Date.I22.first.reported..subsequent.myocardial.infarction. <- as.Date(y$Date.I22.first.reported..subsequent.myocardial.infarction.)
sum(is.na(y$Date.I21.first.reported..acute.myocardial.infarction.)!=T)
y$MI <- 0
y$MI[is.na(y$Date.I21.first.reported..acute.myocardial.infarction.)!=T|is.na(y$Date.I22.first.reported..subsequent.myocardial.infarction.)!=T] <- 1
table(y$MI)

y$MI21_time <- difftime(y$Date.I21.first.reported..acute.myocardial.infarction., y$date_in, units = c("auto"))
y$MI22_time <- difftime(y$Date.I22.first.reported..subsequent.myocardial.infarction., y$date_in, units = c("auto"))

y$MI21_time <- as.numeric(y$MI21_time, units = "days")
y$MI22_time <- as.numeric(y$MI22_time, units = "days")

y$MI_time <- pmin(y$MI22_time,y$MI21_time,na.rm = T)
summary(y$MI_time)
sum(y$MI_time<0,na.rm=T)
y$MI_time[is.na(y$MI_time)==T] <- y$follow_time[is.na(y$MI_time)==T]

y$MI_history <- y$MI
y$MI_history[y$MI_time>0] <- 0
table(y$MI_history)

##stroke------------------
y$stroke <- 0
y$stroke[y$Date.I60.first.reported..subarachnoid.haemorrhage.!=""|
            y$Date.I61.first.reported..intracerebral.haemorrhage.!=""|
            y$Date.I63.first.reported..cerebral.infarction.!=""|
            y$Date.I64.first.reported..stroke..not.specified.as.haemorrhage.or.infarction.!=""] <- 1
table(y$stroke)

y$stroke_time60 <- as.Date(y$Date.I60.first.reported..subarachnoid.haemorrhage.)
y$stroke_time61 <- as.Date(y$Date.I61.first.reported..intracerebral.haemorrhage.)
y$stroke_time63 <- as.Date(y$Date.I63.first.reported..cerebral.infarction.)
y$stroke_time64 <- as.Date(y$Date.I64.first.reported..stroke..not.specified.as.haemorrhage.or.infarction.)

y$stroke_time60 <- difftime(y$stroke_time60, y$date_in, units = c("auto"))
y$stroke_time61 <- difftime(y$stroke_time61, y$date_in, units = c("auto"))
y$stroke_time63 <- difftime(y$stroke_time63, y$date_in, units = c("auto"))
y$stroke_time64 <- difftime(y$stroke_time64, y$date_in, units = c("auto"))

y$stroke_time <- pmin(y$stroke_time60,y$stroke_time61,y$stroke_time63,y$stroke_time64,na.rm = T)
summary(y$stroke_time)
y$stroke_time <- as.numeric(y$stroke_time, units = "days")
summary(y$stroke_time)
y$stroke_time <- y$stroke_time/365
sum(is.na(y$stroke_time)==F)

y$stroke_time <- ifelse(is.na(y$stroke_time)==T,y$follow_time,y$stroke_time)
summary(y$stroke_time)
y$stroke_history <- y$stroke
y$stroke_history[y$stroke_time>0] <- 0
table(y$stroke_history)

####Self-reported doctor diagnosed MI and stroke 暂时不要了----------------------------------
c("red","red","red","red","red","red","red","red","red","red","red","red")
y$CV_doc_history0 <- y$Vascular.heart.problems.diagnosed.by.doctor...Instance.0
y$CV_doc_history1 <- y$Vascular.heart.problems.diagnosed.by.doctor...Instance.1


y$MI_doc_history0[grepl("Heart attack", y$CV_doc_history0)] <- 1
y$MI_doc_history1[grepl("Heart attack", y$CV_doc_history1)] <- 1
table(y$MI_doc_history0,y$MI_doc_history1,exclude = NULL)
y$stroke_doc_history0[grepl("Stroke", y$CV_doc_history0)] <- 1
y$stroke_doc_history1[grepl("Stroke", y$CV_doc_history1)] <- 1

y$MI_doc_history <- y$MI_doc_history1
y$MI_doc_history[is.na(y$MI_doc_history)==T] <- y$MI_doc_history0[is.na(y$MI_doc_history)==T]
table(y$MI_doc_history)
sum(y$MI_doc_history[y$MI_history_d==0],na.rm = T)

table(y$MI_history)
y$MI_history[y$MI_doc_history==1] <- 1
table(y$MI_history)

y$stroke_doc_history <- y$stroke_doc_history1
y$stroke_doc_history[is.na(y$stroke_doc_history)==T] <- y$stroke_doc_history0[is.na(y$stroke_doc_history)==T]
table(y$stroke_doc_history)

table(y$stroke_history)
y$stroke_history[y$stroke_doc_history==1] <- 1
table(y$stroke_history)
c("red","red","red","red","red","red","red","red","red","red","red","red")

##Cancer--------------------
summary(y$cancer_date)
y$cancer <- 0
y$cancer[y$cancer_date <= y$date_in] <- 1
table(y$cancer)

##smoke and fuel-----------------
table(y$Exposure.to.tobacco.smoke.at.home...Instance.0)
table(y$Exposure.to.tobacco.smoke.at.home...Instance.1)
table(y$Exposure.to.tobacco.smoke.outside.home...Instance.0)

y$exposure_tobacco_home_0 <- as.numeric(y$Exposure.to.tobacco.smoke.at.home...Instance.0)
y$exposure_tobacco_outside_0 <- as.numeric(y$Exposure.to.tobacco.smoke.outside.home...Instance.0)
y$exposure_tobacco_home_1 <- as.numeric(y$Exposure.to.tobacco.smoke.at.home...Instance.1)
y$exposure_tobacco_outside_1 <- as.numeric(y$Exposure.to.tobacco.smoke.outside.home...Instance.1)


table(y$Current.tobacco.smoking...Instance.0,exclude = NULL)
table(y$Current.tobacco.smoking...Instance.1,exclude = NULL)

y$exposure_tobacco_home_0[y$Current.tobacco.smoking...Instance.0=="Yes, on most or all days"] <- 168
y$exposure_tobacco_outside_0[y$Current.tobacco.smoking...Instance.0=="Yes, on most or all days"] <- 168
y$exposure_tobacco_home_1[y$Current.tobacco.smoking...Instance.1=="Yes, on most or all days"] <- 168
y$exposure_tobacco_outside_1[y$Current.tobacco.smoking...Instance.1=="Yes, on most or all days"] <- 168

summary(y$exposure_tobacco_home_0)
summary(y$exposure_tobacco_home_1)
y$exposure_tobacco_home <- ifelse(is.na(y$exposure_tobacco_home_1)==T,y$exposure_tobacco_home_0,y$exposure_tobacco_home_1)
summary(y$exposure_tobacco_home)

summary(y$exposure_tobacco_outside_0)
summary(y$exposure_tobacco_outside_1)
y$exposure_tobacco_outside <- ifelse(is.na(y$exposure_tobacco_outside_1)==T,y$exposure_tobacco_outside_0,y$exposure_tobacco_outside_1)
summary(y$exposure_tobacco_outside)

table(y$Gas.or.solid.fuel.cooking.heating...Instance.0)
table(y$Gas.or.solid.fuel.cooking.heating...Instance.1)

# Recode(y$Gas.or.solid.fuel.cooking.heating...Instance.0)
y$solid_fuel_0 <- Recode(y$Gas.or.solid.fuel.cooking.heating...Instance.0,
                       "None of the above::0", 
                       "A gas hob or gas cooker::0", 
                       "A gas hob or gas cooker|A gas fire that you use regularly in winter time::0", 
                       "A gas fire that you use regularly in winter time::0", 
                       "::NA", 
                       "A gas hob or gas cooker|An open solid fuel fire that you use regularly in winter time::1", 
                       "A gas hob or gas cooker|A gas fire that you use regularly in winter time|An open solid fuel fire that you use regularly in winter time::1", 
                       "An open solid fuel fire that you use regularly in winter time::1", 
                       "Prefer not to answer::NA", 
                       "A gas fire that you use regularly in winter time|An open solid fuel fire that you use regularly in winter time::1", 
                       "Do not know::NA", 
                       "NA::",
                       to.numeric = FALSE)
y$solid_fuel_1 <- Recode(y$Gas.or.solid.fuel.cooking.heating...Instance.1,
                         "None of the above::0", 
                         "A gas hob or gas cooker::0", 
                         "A gas hob or gas cooker|A gas fire that you use regularly in winter time::0", 
                         "A gas fire that you use regularly in winter time::0", 
                         "::NA", 
                         "A gas hob or gas cooker|An open solid fuel fire that you use regularly in winter time::1", 
                         "A gas hob or gas cooker|A gas fire that you use regularly in winter time|An open solid fuel fire that you use regularly in winter time::1", 
                         "An open solid fuel fire that you use regularly in winter time::1", 
                         "Prefer not to answer::NA", 
                         "A gas fire that you use regularly in winter time|An open solid fuel fire that you use regularly in winter time::1", 
                         "Do not know::NA", 
                         "NA::",
                         to.numeric = FALSE)

table(y$solid_fuel_1,exclude = NULL)
y$solid_fuel <- ifelse(is.na(y$solid_fuel_1)==T,y$solid_fuel_0,y$solid_fuel_1)
table(y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0[is.na(y$solid_fuel)==T])
# Recode(y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0)
y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0 <- Recode(y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0,
                                                                   "::NA", 
                                                                   "None of the above::0", 
                                                                   "A gas hob::0", 
                                                                   "A gas cooker::0", 
                                                                   "A gas hob|A gas cooker::0", 
                                                                   "A gas hob|An open solid fuel fire that you use regularly in winter time::1", 
                                                                   "An open solid fuel fire that you use regularly in winter time::1", 
                                                                   "A gas cooker|An open solid fuel fire that you use regularly in winter time::1", 
                                                                   "A gas hob|A gas cooker|An open solid fuel fire that you use regularly in winter time::1", 
                                                                   "Prefer not to answer::NA", 
                                                                   "Do not know::NA", 
                                                                   "NA::NA",
                                                                   to.numeric = FALSE)
table(y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0)
table(y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0[is.na(y$solid_fuel)==T])
y$solid_fuel[is.na(y$solid_fuel)==T] <- y$Gas.or.solid.fuel.cooking.heating..pilot....Instance.0[is.na(y$solid_fuel)==T]
table(y$solid_fuel,exclude = NULL)

y1 <- y
summary(y1$follow_time)

#Sample 2-------------
sum(is.na(y1$pm25_mean)==T)
y1 <- subset(y1, is.na(y1$pm25_mean)!=T) #-29
sum(is.na(y1$no2_mean)==T)
sum(y1$Date.lost.to.follow.up!="")
y1 <- subset(y1, Date.lost.to.follow.up=="") #-13

y1 <- subset(y1, cancer==0 & MI_history==0 & stroke_history ==0) #-16664

##Covariate----------------------------
sum(is.na(y1$age)==T |is.na(y1$sex)==T |is.na(y1$white)==T |is.na(y1$college)==T |is.na(y1$smoke)==T 
    |is.na(y1$drinker)==T |is.na(y1$BMI)==T |is.na(y1$TDI)==T | is.na(y1$solid_fuel)==T|
      is.na(y1$Hypertension)==T |is.na(y1$DM_history)==T |
      is.na(y1$Dislipidemia)==T |
      is.na(y1$exposure_tobacco_home)==T|is.na(y1$pm25_mean)==T) #2567
colSums(is.na(y1[, c("age", "sex", "white", "college", "smoke", "drinker", "BMI", "TDI", "solid_fuel", 
                     "Hypertension", "DM_history", "Dislipidemia", "exposure_tobacco_outside", 
                    "exposure_tobacco_home", "pm25_mean")]))
summary(y1$pm25_mean)

y1 <- y1[complete.cases(y1[, c("age", "sex", "white", "college", "smoke", "drinker", "BMI", "TDI", 
                            "solid_fuel","Hypertension", "DM_history", "Dislipidemia", 
                            "exposure_tobacco_home")]), ] 


##PA from accelerator----------------------
y1$MVPA_week_sum <- y1$Moderate.Vigorous...Overall.average...Instance.0*24*60*7
summary(y1$MVPA_week_sum)
y1$MVPA_week_sum_150 <- ifelse(y1$MVPA_week_sum>150,1,0)
y1$MVPA_week_sum_300 <- ifelse(y1$MVPA_week_sum>300,1,0)
IQR(y1$MVPA_week_sum, na.rm = TRUE)
sd(y1$MVPA_week_sum, na.rm = TRUE)

y1$MVPA_week_sum_50 <- y1$MVPA_week_sum/50
y1$MVPA_week_sum_100 <- y1$MVPA_week_sum/100

y1$MVPA_week_sum_5 <- as.factor(cut_number(y1$MVPA_week_sum,5))
# Recode(y1$MVPA_week_sum_5)
y1$MVPA_week_sum_5 <- Recode(y1$MVPA_week_sum_5,
	"[0,91]::1", 
	"(91,182]::2", 
	"(182,289]::3", 
	"(289,454]::4", 
	"(454,3e+03]::5",
	to.numeric = T)

y1$MVPA_week_sum_4 <- as.factor(cut_number(y1$MVPA_week_sum,4))
# Recode(y1$MVPA_week_sum_4)
y1$MVPA_week_sum_4 <- Recode(y1$MVPA_week_sum_4,
	"[0,113]::1", 
	"(113,232]::2", 
	"(232,402]::3", 
	"(402,3e+03]::4",
	to.numeric = FALSE)

y1$MVPA_week_sum_6 <- as.factor(cut_number(y1$MVPA_week_sum,6))
# Recode(y1$MVPA_week_sum_6)
y1$MVPA_week_sum_6 <- Recode(y1$MVPA_week_sum_6,
	"[0,75.5]::1", 
	"(75.5,151]::2", 
	"(151,232]::3", 
	"(232,334]::4", 
	"(334,496]::5", 
	"(496,3e+03]::6",
	to.numeric = FALSE)
summary(y1$MVPA_week_sum_5)
#AP----------------
summary(y1$pm25_mean)
IQR(y1$pm25_mean, na.rm = TRUE)
sd(y1$pm25_mean, na.rm = TRUE)
y1$pm25_IQR <- y1$pm25_mean/2.14
y1$pm25_sd <- y1$pm25_mean/1.64

y1$pm25_2 <- as.factor(cut_number(y1$pm25_mean,2))
# Recode(y1$pm25_2)
y1$pm25_2 <- Recode(y1$pm25_2,
	"[0,9.36]::0", 
	"(9.36,16.9]::1",
	to.numeric = FALSE)


y1$pm25_3 <- as.factor(cut_number(y1$pm25_mean,3))
# Recode(y1$pm25_3)
y1$pm25_3 <- Recode(y1$pm25_3,
	"[0,8.63]::1", 
	"(8.63,10]::2", 
	"(10,16.9]::3",
	to.numeric = FALSE)


y1$pm25_4 <- as.factor(cut_number(y1$pm25_mean,4))
# Recode(y1$pm25_4)
y1$pm25_4 <- Recode(y1$pm25_4,
	"[0,8.23]::1", 
	"(8.23,9.36]::2", 
	"(9.36,10.4]::3", 
	"(10.4,16.9]::4",
	to.numeric = FALSE)


#Save---------------------------
#save.image(file = "D:/Projects/UKB/2-PA-AP/Code/PA_AP.RData")
#load(file = "D:/Projects/UKB/2-PA-AP/Code/PA_AP.RData")

#Prevalence---------
summary(y1$follow_time)
table(y1$Mort)
table(y1$CVD_death)
table(y1$IHD_death)
table(y1$AMI_death)
table(y1$CIHD_death)

table(y1$Cere_death)
table(y1$Stroke_death)
table(y1$Resp_death)
table(y1$Cancer_death)

summary(y1$MVPA_week_sum)

table(y1$MVPA_week_sum_150)
summary(y1$pm25_mean)
sd(y1$pm25_mean)


#Baseline table---------
variables_to_convert <- c("sex", "white","college","employment","smoke", "drinker",
                          "Mort","Hypertension","Dislipidemia","DM_history",
                          "solid_fuel","MVPA_week_sum_150")

y1[variables_to_convert] <- lapply(y1[variables_to_convert], factor)
t1 <- descrTable(Mort~age+sex+white+TDI+college+employment+BMI+smoke+drinker+
                   +Hypertension+Dislipidemia+DM_history+
                   MVPA_week_sum+MVPA_week_sum_150+pm25_mean+solid_fuel+exposure_tobacco_home, data = y1,digits = 2,
                 method = c(MVPA_week_sum=2,exposure_tobacco_home=2),
                 hide.no = "0",show.p.mul = TRUE,show.all = T)
export2csv(t1, file='D:/Projects/UKB/2-PA-AP/Data/Table/table1_Mort.csv')
summary(y1$exposure_tobacco_home)
#baseline-association-----------------
library(ggExtra)

# classic plot :
p<-ggplot(data=y1, aes(x=pm25_mean, y=MVPA_week_sum),fill="#F47871") +
  geom_point(color="#003472",shape=16) +
  theme(legend.position="none")+
  theme_bw()+labs(x="PM2.5 (ug/m3)",y="MVPA (min/week)")+
  theme(axis.line = element_line(colour = "black"))

# Set relative size of marginal plots (main plot 10x bigger than marginals)
ggMarginal(p, type="histogram",fill = "#40a798", size=10)
cor.test(y1$pm25_mean, y1$MVPA_week_sum,  method = "spearman")

#AP-RCS------------------
quantile(y1$pm25_mean, probs = c(0.001, 0.999), na.rm = TRUE)
summary(y1$pm25_mean)
yx <- subset(y1,y1$pm25_mean>5 & y1$pm25_mean < 14.4)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
##All-cause---------------
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CVD---------------
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "B. CVD Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 5), 
                                                                    breaks = seq(0,5, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##Cere---------------
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 6), 
                                                                    breaks = seq(0,6, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##IHD---------------
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "D. IHD Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 6), 
                                                                    breaks = seq(0,6,1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##AMI---------------
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 20), 
                                                                    breaks = seq(0,20,5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



##CIHD---------------
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=dt) 
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, pm25_mean,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(pm25_mean,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(pm25_mean,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "PM2.5 (ug/m3)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(5,14)+scale_y_continuous(limits = c(0, 4), 
                                                                    breaks = seq(0,4,1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,20),breaks = seq(0,20,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(5,14) +theme(axis.line = element_line(color = "black"),
                                                        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##AP-Cox-----------------
coxph(Surv(follow_time,Mort==1) ~ pm25_IQR,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ pm25_IQR,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ pm25_IQR,data=y1)|>reportReg()
coxph(Surv(follow_time,IHD_death==1) ~ pm25_IQR,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ pm25_IQR,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ pm25_IQR,data=y1)|>reportReg()


coxph(Surv(follow_time,Mort==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()
coxph(Surv(follow_time,IHD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=y1)|>reportReg()


coxph(Surv(follow_time,AMI_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+exposure_tobacco_home,data=subset(y1, pm25_mean >10))|>reportReg()

#PA-RCS------------------
quantile(y1$MVPA_week_sum, probs = c(0.001, 0.999), na.rm = TRUE)
yx <- subset(y1, y1$MVPA_week_sum>=0 & y1$MVPA_week_sum < 1200)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
##All-cause---------------
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  geom_vline(xintercept = 400, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "A. All-cause Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



##CVD---------------
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  geom_vline(xintercept = 400, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "B. CVD Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##Cere---------------
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##IHD---------------
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "D. IHD Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##AMI---------------
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##CIHD---------------
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#631879ff") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="#f9f7f7",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##PA-Cox----------------
coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100,data=y1)|>reportReg()


coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()


coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_150,data=y1)|>reportReg()

coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()

coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_150+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)|>reportReg()

coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,MVPA_week_sum <= 400))|>reportReg()
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,MVPA_week_sum <= 400))|>reportReg()


#Effect of AP at different level of MVPA--------------------------
##Overall------------
###PM2.5----
####All-cause----------------------
quantile(y1$pm25_mean, probs = c(0.001, 0.999), na.rm = TRUE)
summary(y1$pm25_mean)
fit<-cph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
        panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.7,1.2)

####CVD----------------------

fit<-cph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "B. CVD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.6,1.4)

####Cere----------------------
fit<-cph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.8), 
                                                                        breaks = seq(0.2, 1.8, 0.4))


####IHD----------------------
fit<-cph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "D. IHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 1.6), 
                                                                         breaks = seq(0.4, 1.6, 0.2))


####AMI----------------------
fit<-cph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 2), 
                                                                        breaks = seq(0.4, 2, 0.4))


####CIHD----------------------
fit<-cph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y1)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y1,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y1, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.4), 
                                                                        breaks = seq(0.2, 1.4, 0.2))


#AP分组的MVPA RCS: PM2.5---------------
##All-cause--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean >= 10 & MVPA_week_sum < 400)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
summary(dt)
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##CVD--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean < 10)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##Cere--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean >= 10)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Disease Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 8), 
                                                                      breaks = seq(0,8, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##IHD--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean >= 10 & MVPA_week_sum >=400)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4,1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##AMI--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean >= 10 &MVPA_week_sum<400)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 10), 
                                                                      breaks = seq(0,10, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CIHD--------
y1$pm25_12 <- ifelse(y1$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
fit_a1 <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y1)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y1,pm25_mean < 10)) |> reportReg()

yx <- subset(y1, y1$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y1, y1$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y1, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


#Sensitivity analysis-------------------------------
##exclude events that occurred first year after PA assessment
summary(y1$follow_time)
sum(y1$follow_time < 1 & y1$Mort ==1)
y001 <- subset(y1,!(follow_time < 1 & Mort == 1)) #77776人

#S1:Interaction-RCS-------------------------
##PM2.5--------------
fit<-cph(Surv(follow_time,Mort==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
           exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
summary(y001$MVPA_week_sum)
quantile(y001$MVPA_week_sum, probs = c(0.01, 0.99), na.rm = TRUE)
HR<- intEST(var2values = c(0:1116),model = fit,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+  theme(axis.line = element_line(color = "black"),
                                                           panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0.5, 3), 
                                                                      breaks = seq(0.5, 3, 0.5))

coxph(Surv(follow_time,Mort==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum >=400)) |> reportReg()


fit1<-cph(Surv(follow_time,CVD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit1,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.189734, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "B. CVD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1)+xlim(0,1116)+scale_y_continuous(limits = c(0.5,5.5),breaks = seq(0.5, 5.5, 1))

coxph(Surv(follow_time,CVD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum>750)) |> reportReg()

fit3<-cph(Surv(follow_time,Cere_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit3,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")

p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,5), 
                                                                      breaks = seq(0, 5, 1),labels = scales::label_number(accuracy = 0.1))


fit2<-cph(Surv(follow_time,IHD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit2,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.046980, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "D. IHD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,10), 
                                                                      breaks = seq(0, 10, 2),labels = scales::label_number(accuracy = 0.1))

coxph(Surv(follow_time,IHD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum>500)) |> reportReg()


fit21<-cph(Surv(follow_time,AMI_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
             drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
             exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit21,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.738044, linetype = 2, linewidth = 0.6, color = "red") + 
  #geom_vline(xintercept = 320, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+  scale_x_continuous(limits = c(0,1116), breaks = seq(0,1116,300))+
  scale_y_continuous(limits = c(0,20),breaks = seq(0, 20, 4.0),labels = scales::label_number(accuracy = 0.1))


c1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(0,920)+  theme(axis.line = element_line(color = "black"),
                                                          panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")
c2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.738044, linetype = 2, linewidth = 0.6, color = "red") + 
  #geom_vline(xintercept = 320, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +scale_x_continuous(limits = c(0,920), breaks = seq(0,1000,300))+
  scale_y_continuous(limits = c(0,12),breaks = seq(0,12, 2.0),labels = scales::label_number(accuracy = 0.1))

topptx(filename ="D:/Projects/UKB/2-PA-AP/Data/Fig/Central-Image3.pptx",width =4, height =4, units = "cm")

fit22<-cph(Surv(follow_time,CIHD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
             drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
             exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit22,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,8), 
                                                                      breaks = seq(0, 8, 2),labels = scales::label_number(accuracy = 0.1))


#S1:Effect of AP at different level of MVPA--------------------------
##Overall------------
###PM2.5----
####All-cause----------------------
quantile(y001$pm25_mean, probs = c(0.001, 0.999), na.rm = TRUE)
summary(y001$pm25_mean)
fit<-cph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.7,1.2)


####CVD----------------------

fit<-cph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "B. CVD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.6,1.4)



####Cere----------------------
fit<-cph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.8), 
                                                                        breaks = seq(0.2, 1.8, 0.4))


####IHD----------------------
fit<-cph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "D. IHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 1.6), 
                                                                        breaks = seq(0.4, 1.6, 0.2))


####AMI----------------------
fit<-cph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 2), 
                                                                        breaks = seq(0.4, 2, 0.4))



####CIHD----------------------
fit<-cph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.4), 
                                                                        breaks = seq(0.2, 1.4, 0.2))



#S1:AP分组的MVPA RCS: PM2.5---------------
##All-cause--------
y001$pm25_2 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*pm25_2+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10 & MVPA_week_sum >= 400)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CVD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##Cere--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean >= 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 6), 
                                                                      breaks = seq(0,6, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Disease Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 5), 
                                                                      breaks = seq(0,5, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##IHD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4,1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##AMI--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean >= 10 &MVPA_week_sum<400)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 10), 
                                                                      breaks = seq(0,10, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CIHD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



#Sensitivity analysis2----------------
#exclude participants who moved more than 3 times during the study period-----
loca <- read.csv("E:/Database/UKB/Location/Location.csv", stringsAsFactors=FALSE)
loca <- subset(loca, select = c("Participant.ID", grep("^Date_location_", names(loca), value = TRUE)))
y1 <- merge(y1, loca, by = "Participant.ID", all.x = TRUE)
for (i in 0:14) {
  # 构建当前Date_location变量的列名
  col_name <- paste0("Date_location_", i)
  
  # 将当前Date_location变量转换为日期型
  y1[, col_name] <- as.Date(y1[, col_name])
  
  # 判断当前Date_location变量是否小于2010-1-1,如果小于则赋值为NA
  y1[!is.na(y1[, col_name]) & y1[, col_name] < as.Date("2010-01-01"), col_name] <- NA
  
  # 判断当前Date_location变量是否大于date_end,如果大于则赋值为NA,否则保持原值
  y1[!is.na(y1[, col_name]) & y1[, col_name] > y1$date_end, col_name] <- NA
}
summary(y1$Date_location_0)

y1$home_number <- rowSums(!is.na(y1[grepl("^Date_location_", names(y1))]))
table(y1$home_number)

y001 <- subset(y1,y1$home_number <= 3) #77428

#S2:Interaction-RCS-------------------------
##PM2.5--------------
fit<-cph(Surv(follow_time,Mort==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
           exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
summary(y001$MVPA_week_sum)
quantile(y001$MVPA_week_sum, probs = c(0.01, 0.99), na.rm = TRUE)
HR<- intEST(var2values = c(0:1116),model = fit,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+  theme(axis.line = element_line(color = "black"),
                                                           panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0.5, 3), 
                                                                      breaks = seq(0.5, 3, 0.5))


coxph(Surv(follow_time,Mort==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum >=400)) |> reportReg()


fit1<-cph(Surv(follow_time,CVD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit1,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.189734, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "B. CVD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1)+xlim(0,1116)+scale_y_continuous(limits = c(0.5,5.5),breaks = seq(0.5, 5.5, 1))

coxph(Surv(follow_time,CVD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum>750)) |> reportReg()

fit3<-cph(Surv(follow_time,Cere_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit3,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")

p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,5), 
                                                                      breaks = seq(0, 5, 1),labels = scales::label_number(accuracy = 0.1))



fit2<-cph(Surv(follow_time,IHD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
            exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit2,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.046980, linetype = 2, linewidth = 0.6, color = "red") +
  labs(title = "D. IHD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,12), 
                                                                      breaks = seq(0, 12, 3),labels = scales::label_number(accuracy = 0.1))

coxph(Surv(follow_time,IHD_death==1) ~ pm25_IQR+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
        exposure_tobacco_home,data=subset(y001,MVPA_week_sum>500)) |> reportReg()


fit21<-cph(Surv(follow_time,AMI_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
             drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
             exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit21,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  #geom_hline(yintercept = 2.738044, linetype = 2, linewidth = 0.6, color = "red") + 
  #geom_vline(xintercept = 320, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+  scale_x_continuous(limits = c(0,1116), breaks = seq(0,1116,300))+
  scale_y_continuous(limits = c(0,25),breaks = seq(0, 25, 5.0),labels = scales::label_number(accuracy = 0.1))
aligned_plots <- align_plots(p1, p2, align="hv", axis="tblr")
I5 <- ggdraw(aligned_plots[[1]]) + draw_plot(aligned_plots[[2]])

fit22<-cph(Surv(follow_time,CIHD_death==1) ~ pm25_IQR*rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
             drinker+BMI+Hypertension+Dislipidemia+DM_history+solid_fuel+
             exposure_tobacco_home,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:1116),model = fit22,data = y001,var1 = "pm25_IQR",var2 = "MVPA_week_sum",ci.method = "delta")


p2 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#631879ff") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,color = "#631879ff",fill = "transparent",linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "MVPA (min/week)", y = "HR for each interquartile range increase in PM2.5") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0,8), 
                                                                      breaks = seq(0, 8, 2),labels = scales::label_number(accuracy = 0.1))




#S2:Effect of AP at different level of MVPA--------------------------
##Overall------------
###PM2.5----
####All-cause----------------------
quantile(y001$pm25_mean, probs = c(0.001, 0.999), na.rm = TRUE)
summary(y001$pm25_mean)
fit<-cph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "A. All-cause Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.7,1.2)


####CVD----------------------

fit<-cph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "B. CVD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+ylim(0.6,1.4)



####Cere----------------------
fit<-cph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "C. Cerebrovascular Disease Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.8), 
                                                                        breaks = seq(0.2, 1.8, 0.4))



####IHD----------------------
fit<-cph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "D. IHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 1.6), 
                                                                        breaks = seq(0.4, 1.6, 0.2))



####AMI----------------------
fit<-cph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "E. AMI Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.4, 2), 
                                                                        breaks = seq(0.4, 2, 0.4))



####CIHD----------------------
fit<-cph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*rcs(pm25_mean,3)+age+sex+white+college+TDI+smoke+
           drinker+BMI+Hypertension+Dislipidemia+DM_history,x=TRUE, y=TRUE,data=y001)
HR<- intEST(var2values = c(0:16.937),model = fit,data = y001,var1 = "MVPA_week_sum_100",var2 = "pm25_mean",ci.method = "delta")


p1 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 0.5,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+  theme(axis.line = element_line(color = "black"),
                                                             panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

p2 <- ggplot(y001, aes(x = pm25_mean)) +
  geom_line(data = HR, aes(Value, HR), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(Value, ymin = CI_L, ymax = CI_U), alpha = 0.1, linewidth = 0.6,fill = "transparent",color = "#003366", linetype = "dashed") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "F. CIHD Mortality", x = "PM2.5 (μg/m3)", y = "HR (95%CI) for 100 minutes increase in MVPA time") +
  theme_half_open(11, rel_small = 1) +xlim(4,16.937)+scale_y_continuous(limits = c(0.2, 1.4), 
                                                                        breaks = seq(0.2, 1.4, 0.2))


#S2:AP分组的MVPA RCS: PM2.5---------------
##All-cause--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Mort==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10 & MVPA_week_sum >= 400)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Mort==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "All-cause Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CVD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CVD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CVD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CVD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 2.5), 
                                                                      breaks = seq(0,2.5, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


##Cere--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,Cere_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean >= 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,Cere_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "Cerebrovascular Disease Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 8), 
                                                                      breaks = seq(0,8, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



##IHD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,IHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean < 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4,1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")


yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,IHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "IHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



##AMI--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,AMI_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean >= 10 &MVPA_week_sum<400)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 10), 
                                                                      breaks = seq(0,10, 2), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,AMI_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "AMI Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")

##CIHD--------
y001$pm25_12 <- ifelse(y001$pm25_mean >= 10,1,0)
fit_a <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
                 drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
fit_a1 <- coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100*pm25_12+age+sex+white+college+TDI+smoke+
                  drinker+BMI+Hypertension+Dislipidemia+DM_history,data=y001)
anova(fit_a,fit_a1,test="chisq")
lmtest::lrtest(fit_a,fit_a1)
coxph(Surv(follow_time,CIHD_death==1) ~ MVPA_week_sum_100+age+sex+white+college+TDI+smoke+
        drinker+BMI+Hypertension+Dislipidemia+DM_history,data=subset(y001,pm25_mean >= 10)) |> reportReg()

yx <- subset(y001, y001$pm25_mean>=10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)
HR$upper[HR$upper>20] <- 20
p1 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 >= 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 4), 
                                                                      breaks = seq(0,4, 1), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")



yx <- subset(y001, y001$pm25_mean<10)
dt <- subset(yx, select = c(MVPA_week_sum,age,sex,pm25_2,pm25_3,pm25_4,
                            follow_time,Mort,CVD_death,Resp_death,Cere_death,IHD_death,AMI_death,CIHD_death,
                            pm25_mean,no2_mean,white,college,TDI,smoke,drinker,
                            BMI,Hypertension,Dislipidemia,DM_history,
                            solid_fuel,exposure_tobacco_home))
dd <- datadist(dt) #为后续程序设定数据环境
options(datadist='dd') #为后续程序设定数据环境
# 拟合模型
fit<- cph(Surv(follow_time,CIHD_death==1) ~ rcs(MVPA_week_sum,3)+age+sex+white+college+TDI+smoke+
            drinker+BMI+Hypertension+Dislipidemia+DM_history,data=dt) 
dd$limits$MVPA_week_sum[2] <- 400 ###这里是设置参考点，也就是HR为1的点，常见的为中位数或者临床有意义的点 
fit=update(fit)
# P<0.05为存在非线性关系
anova(fit)
HR<-Predict(fit, MVPA_week_sum,fun=exp,ref.zero = TRUE)

p1 <- ggplot(y001, aes(x = MVPA_week_sum)) +
  geom_line(data = HR, aes(MVPA_week_sum,yhat), linetype = "solid", linewidth = 0.6, alpha = 1, color = "#003366") +
  geom_ribbon(data = HR, aes(MVPA_week_sum,ymin = lower, ymax = upper), alpha = 0.1, linewidth = 0.6,fill = "#003366") +
  geom_hline(yintercept = 1, linetype = 2, linewidth = 0.6, color = "black") +
  labs(title = "CIHD Mortality, PM2.5 < 10ug/m3", x = "MVPA (min/week)", y = "Hazard Ratio") +
  theme_half_open(11, rel_small = 1) +xlim(0,1116)+scale_y_continuous(limits = c(0, 3), 
                                                                      breaks = seq(0,3, 0.5), labels = scales::label_number(accuracy = 0.1))
p2 <- ggplot(yx, aes(x = MVPA_week_sum)) +
  geom_histogram(aes(y=(..count..)*100/sum(..count..)),binwidth= 50,show.legend = FALSE,fill="gray90",color="gray80") +
  scale_y_continuous(limits=c(0,16),breaks = seq(0,16,4),
                     position = "right",name = "Percentage of population(%)")+
  theme_half_open(11, rel_small = 1) +xlim(10,1116)+  theme(axis.line = element_line(color = "black"),
                                                            panel.grid = element_blank(),panel.border = element_rect(colour = "black", fill=NA))+
  rremove("x.axis")+
  rremove("xlab") +
  rremove("x.text") +
  rremove("x.ticks") +
  rremove("legend")
